@using MasterReservation.Models
@model object[]

@{
    ViewBag.Title = "Список забронированных слотов";
}

@Scripts.Render("~/bundles/jqueryval")
@Scripts.Render("~/Scripts/jquery-ui-1.12.1.min.js")
@Scripts.Render("~/Scripts/datepicker.js")
@Scripts.Render("~/Scripts/slick.min.js")


@Styles.Render("~/Content/themes/base/jquery-ui.min.css")
@Styles.Render("~/Content/datepicker.css")
@Styles.Render("~/Content/slick/slick.css")
@Styles.Render("~/Content/slick/slick-theme.css")
@Styles.Render("~/Content/ShowBookedResidentsStyles.css")

@*@if (@ViewBag.ErrorMessage != null)
    {
        <span class="error-message">@ViewBag.ErrorMessage</span>
    }
    @if ((Model[0] as List<BookingModel>).Count == 0)
    {
        <span class="info-message">Бронирований пока нет</span>
    }

    <div class="table-wrap" style="max-height: 500px; overflow-y: scroll;">
        <table class="table">
            <thead class="thead-light">
                <tr>
                    <th>Id</th>
                    <th>Id рабочего места</th>
                    <th>Имя</th>
                    <th>Фамилия</th>
                    <th>Город</th>
                    <th>Телефон</th>
                    <th>Email</th>
                    <th>Опыт работы</th>
                    <th>Награды</th>
                    <th>Услуги</th>
                    <th>Дата</th>
                    <th>Время</th>
                    <th>Доп.Информация</th>
                    <th>Сумма</th>
                    <th>Управление</th>

                </tr>
            </thead>
            <tbody>

                @if ((Model[0] as List<BookingModel>).Count != 0)
                {
                    foreach (var model in (Model[0] as List<BookingModel>))
                    {

                        string times = model.Times;


                        List<string> listTimes = times.Split(';').ToList();
                        int combinedTime = 0;
                        int prevTime = Int32.Parse(listTimes[0].Split('-')[0].Split(':')[0]);

                        for (int j = 1; j < listTimes.Count - 1; j++)
                        {
                            if (++prevTime == Int32.Parse(listTimes[j].Split('-')[0].Split(':')[0]))
                            {
                                combinedTime++;
                            }
                        }


                        if (combinedTime + 1 == listTimes.Count-1)
                        {

                            times = listTimes.First().Split('-')[0] + "-" + listTimes[listTimes.Count-2].Split('-')[1];

                        }
                <tr>
                    <td>@(model.Id)</td>
                    <td>@(model.PlaceId)</td>
                    @if (model.ResidentId == 0)
                    {
                        <td>@(model.Name)</td>
                        <td>@(model.Surname)</td>
                        <td></td>
                        <td>@(model.Phone)</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    }
                    else
                    {
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Name)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Surname)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().City)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Phone)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Email)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Experience)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Awards)</td>
                        <td>@((Model[1] as List<ResidentModel>).Where(t => t.Id == model.ResidentId).FirstOrDefault().Offers)</td>
                    }



                    <td>@(model.Date.ToString("dddd, d MMMM"))</td>
                    <td>@(times + "(" + (listTimes.Count - 1) + ")")</td>
                    <td>@(model.Info)</td>
                    <td>@(model.Sum.ToString("F") + "р")</td>
                    <td><button class="btn btn-danger salon-dlt-btn viewDialog" value="@(model.Id)">Удалить</button></td>
                </tr>

                    }
                }
                <tr>
                    @using (Html.BeginForm("AddSalon", "Admin", FormMethod.Post, new { }))
                    {
                        @Html.HiddenFor((model => (Model[1] as SalonModel).Id))
                        <td>*</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).SalonTitle, new { htmlAttributes = new { @class = "field", placeholder = "Название салона" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).ContactPerson, new { htmlAttributes = new { @class = "field", placeholder = "Контактное лицо" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).Phone, new { htmlAttributes = new { @class = "field phone-mask", placeholder = "Номер телефона" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).City, new { htmlAttributes = new { @class = "field", id = "city-input", placeholder = "Город" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).Email, new { htmlAttributes = new { @class = "field", placeholder = "Email" } })</td>
                        <td>@Html.TextAreaFor(model => (Model[1] as SalonModel).Message, new { @class = "field", placeholder = "Сообщение" })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).Adress, new { htmlAttributes = new { @class = "field", placeholder = "Адрес" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).OperatingMode, new { htmlAttributes = new { @class = "field mode-mask", placeholder = "Режим работы" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).ReservationType, new { htmlAttributes = new { id = "checkbox" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).AdminEmail, new { htmlAttributes = new { @class = "field" } })</td>
                        <td>@Html.EditorFor(model => (Model[1] as SalonModel).AdminPass, new { htmlAttributes = new { @class = "field" } })</td>
                        <td><button class="btn btn-primary">Добавить</button></td>
                    }
                </tr>
            </tbody>
        </table>

    </div>*@


<div class="main-container">
    <div class="left-wrap">
        <span class="sub-title">
            Выберите дату:
        </span>
        <div id="calendar" class="calendar"></div>
    </div>
    <div class="center-wrap">
        @{
            List<List<int>> workingTimes = (Model[0] as List<List<int>>);
            List<WorkingPlaceModel> places = (Model[1] as List<WorkingPlaceModel>);
            List<BookingModel> bookings = (Model[2] as List<BookingModel>);
            List<ResidentModel> residents = (Model[3] as List<ResidentModel>);
            string[] titleArr = new string[] {"sun","mon","tue","wed","thu","fri","sat"};
            
            int dayOfWeek;
        }
        @for (var i=0;i<titleArr.Length;i++)
        {

            <div class="times title-time-@titleArr[i]">
                @for (var j=workingTimes[i][0];j<workingTimes[i][1];j++)
                {
                    <span class="span-time">@j:00</span>
                }
            </div>
        }

        <div class="slider-places">
            @for (var k=0; k<places.Count;k++)
            {
                DateTime date = DateTime.Today;
                <div class="slider-card" value="@places[k].Id">
                    <div class="card-head">
                        <a href="WorkingPlacePage/@places[k].Id"><img src="~/Resources/img/default-card-img.png" width="100px" height="100px" /></a>
                        <div class="head-title-text">
                            @for (var h = 0; h < places[k].Offers.Split(',').Length - 1; h++)
                            {
                                <span class="head-title">
                                    @places[k].Offers.Split(',')[h]
                                </span>
                            }
                        </div>
                    </div>

                    @while (date != DateTime.Today.AddDays(14))
                    {

                        dayOfWeek = (int)date.DayOfWeek;
                        List<int> usedTimes = new List<int>();
                        <table class="time-table time-@titleArr[dayOfWeek]" value="@date.ToString("dd-MM-yyyy")">
                            @for (var j = workingTimes[dayOfWeek][0]; j < workingTimes[dayOfWeek][1] - 1; j++)
                            {
                                var overlaps = bookings.Where(t => t.PlaceId == places[k].Id && t.Date == date);
                                List<List<string>> bookedHours = new List<List<string>>();
                                int iUser = 0;
                                foreach (var overlap in overlaps)
                                {
                                    foreach (var overlap2 in overlap.Times.Split(';'))
                                    {
                                        if (overlap2 == "")
                                        {
                                            continue;
                                        }
                                        bookedHours.Add(new List<string>(){overlap2.Split(':')[0], overlap.ResidentId.ToString(), overlap.Id.ToString(), overlap.Name, overlap.Surname});
                                    }

                                }
                                if (!bookedHours.Any())
                                {
                                    <tr>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    continue;
                                }
                                int rowspan = 0;
                                if (!usedTimes.Contains(j))
                                {
                                    List<string> findedBooking = new List<string>();
                                    foreach (var booked in bookedHours)
                                    {
                                        findedBooking.Add(booked[0]);
                                    }
                                    if (findedBooking.Contains(j.ToString()))
                                    {
                                        int adder = 1;
                                        while (true)
                                        {

                                            if (findedBooking.Contains((j+adder).ToString()))
                                            {
                                                usedTimes.Add(j+adder);
                                                rowspan++;
                                                adder++;
                                            }
                                            else
                                            {
                                                break;
                                            }
                                        }
                                        rowspan++;
                                        ResidentModel resident = residents.FirstOrDefault(t => t.Id.ToString() == bookedHours[iUser][1]);
                                        if (resident == null)
                                        {
                                            <tr>
                                                <td colspan="2" rowspan="@rowspan" class="booked-slot">@bookedHours[iUser][4] @bookedHours[iUser][3]<img src="~/Resources/img/close-modal.png" value="@bookedHours[iUser][2]" class="delete-record viewDialog" /></td>
                                            </tr>
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="2" rowspan="@rowspan" class="booked-slot">@resident.Surname @resident.Name<img src="~/Resources/img/close-modal.png" value="@bookedHours[iUser][2]" class="delete-record viewDialog" /></td>
                                            </tr>
                                        }
                                        
                                    }
                                    
                                        if (rowspan == 0)
                                        {
                                            <tr>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                        }
                                        else
                                        {
                                            rowspan--;
                                            while (rowspan != 0)
                                            {
                                                <tr></tr>
                                            rowspan--;
                                        }
                                    }
                                    iUser++;

                                }

                            }
                        </table>
                        date = date.AddDays(1);
                    }
                    
                </div>
            }
        </div>
    </div>
    <div class="right-wrap">
        <span class="right-title">
            Все рабочие места:
        </span>
        <div class="all-places">
            @foreach (var place in places)
            {
                <img src="~/Resources/img/default-card-img.png" value="@place.Id" filtered="false" />
            }
        </div>
    </div>
</div>



<script>
    //$(".salon-mng-btn").on("click", function () {
    //    document.location = "../../Admin/SalonPlaces/" + $(this).val();
    //});

    //$(".phone-mask").mask("+7(999)9999999");

    //$.mask.definitions['~'] = '[0-2]';
    //$.mask.definitions['+'] = '[0-5]';
    //$(".mode-mask").mask("~9:00 - ~9:00");


    //$("#city-input").each(function () {
    //    $(this).autocomplete({
    //        source: '/Authentication/GetCities'
    //    });
    //});
    let filtered = false;
    $(".all-places img").on("click",
        function (e) {
            if ($(this).attr("filtered") == "false") {
                $(".slider-places").slick('slickUnfilter');
                $(".slider-places").slick('slickFilter', '[value="' + this.getAttribute("value") + '"]');
                $(".slider-places").slick("slickSetOption", "slidesToShow", 1, true);
                $(".all-places img").attr("filtered", false);
                $(this).attr("filtered", true);
            } else {
                $(".slider-places").slick('slickUnfilter');
                $(".slider-places").slick("slickSetOption", "slidesToShow", 3, true);
                $(".all-places img").attr("filtered", false);
            }
        }
    );

    $(".slider-places").slick({
        infinite: false,
        slidesToShow: 3,
        slidesToScroll: 1,

        responsive: [
            {
                breakpoint: 1199,
                settings: {
                    slidesToShow: 2
                }
            },
            {
                breakpoint: 840,
                settings: {
                    slidesToShow: 1
                }
            }
        ]
    });

    refreshSlots(new Date());

    function refreshSlots(date) {
        $(".time-table").hide();
        $(".times").hide();
        let formatted_date = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
        $("[value='" + formatted_date + "']").show();
        switch (date.getDay()) {
            case 1:
                $(".title-time-mon").show();
                break;
            case 2:
                $(".title-time-tue").show();
                    break;
            case 3:
                $(".title-time-wed").show();
                    break;
            case 4:
                $(".title-time-thu").show();
                    break;
            case 5:
                $(".title-time-fri").show();
                    break;
            case 6:
                $(".title-time-sat").show();
                    break;
            case 0:
                $(".title-time-sun").show();
                    break;
        }

    }

    // календарь
    var calendar1 = $('#calendar').datepicker({
        minDate: new Date(),
        toggleSelected: false,
        onRenderCell: function (date, cellType) {

            var currentDate = date.getDate();
            var currentMonth = date.getMonth();
            var currentYear = date.getFullYear();
        },
        onSelect: function onSelect(fd, date, inst) {
            refreshSlots(date);
        }
    }).data('datepicker');



    $(".viewDialog").on("click", function (e) {
        e.preventDefault();
        $("<div><button class='btn btn-primary btn-sm' onclick='deletebook({id})'>Да</button><button class='btn btn-secondary btn-sm' onclick='$(\".dialog\").remove();'>Нет</button></div>".replace("{id}", e.target.getAttribute("value")))
            .addClass("dialog")
            .appendTo("body")
            .dialog({
                title: "Вы уверены?",
                close: function () { $(this).remove() },
                modal: true
            });
    });

    function deletebook(id){
        $.ajax({
            type: "GET",
            url: '@Url.Action("RemoveBookingAjax", "BookingSlots")',
            data: "id=" + id,
            success: function (data) {
                if (data == "True") {
                    $("[value = {id}]".replace("{id}", id)).parent().parent().remove();
                    $(".dialog").remove();
                    alert("Бронирование отменено!");
                    location.reload();
                } else {
                    alert("Произошла ошибка, попробуйте позже");
                }
            },
            error: function () {
                alert("Произошла ошибка, попробуйте позже");
            }
        });
    }



    @*$(".salon-dlt-btn").on("click", function (e) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("RemoveBookingAjax", "BookingSlots")',
            data: "id=" + $(this).val(),
            success: function (data) {
                if (data) {
                    $(e.target).parent().parent().remove();
                    alert("Бронирование отменено!");
                } else {
                    alert("Произошла ошибка, попробуйте позже");
                }
            },
            error: function () {
                alert("Произошла ошибка, попробуйте позже");
            }
        });



    });*@


</script>